user www-data;

worker_processes auto;

# فایل PID برای مدیریت پروسه nginx
pid /run/nginx.pid;

include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 4096;
    # multi_accept on; # فعال کردن این گزینه در ترافیک بالا می‌تواند مفید باشد
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    reset_timedout_connection on;
    types_hash_max_size 2048;
    server_tokens off; # مخفی کردن نسخه nginx برای امنیت

    # MIME Types
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ------ لاگ‌ها ------
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # ------ تنظیمات Gzip بهینه ------
    gzip on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_vary on;
    gzip_proxied any;
    gzip_disable "msie6";
    gzip_types
        text/plain text/css text/xml application/xml application/xml+rss
        application/json application/javascript application/x-javascript
        text/javascript image/svg+xml;

    # ------ تنظیمات مورد نیاز برای WebSocket ------
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    
    # ------ کش پراکسی ------
    # این مسیر باید وجود داشته و پرمیشن لازم را داشته باشد
    proxy_cache_path /var/cache/nginx/static levels=1:2 keys_zone=STATIC:50m max_size=1g inactive=7d use_temp_path=off;

    # ------ اگر داخل کانتینر اجرا می‌کنی: DNS داکر ------
    resolver 127.0.0.11 valid=30s ipv6=off;
    resolver_timeout 2s;

    include /etc/nginx/conf.d/*.conf;
}