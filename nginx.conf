worker_processes auto;

events {
    worker_connections 4096;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # امنیت و پرفورمنس عمومی
    server_tokens off;
    sendfile on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    reset_timedout_connection on;

    # اگر داخل کانتینر اجرا می‌کنی: DNS داکر
    resolver 127.0.0.11 valid=30s ipv6=off;
    resolver_timeout 2s;

    # Gzip بهینه
    gzip on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_vary on;
    gzip_proxied any;
    gzip_disable "msie6";
    gzip_types
        text/plain text/css text/xml application/xml application/xml+rss
        application/json application/javascript application/x-javascript
        text/javascript image/svg+xml;

    map $http_upgrade $connection_upgrade {
        default close;
        "websocket" upgrade;
    }

    proxy_cache_path /var/cache/nginx/static levels=1:2 keys_zone=STATIC:50m max_size=1g inactive=7d use_temp_path=off;

    upstream profile_upstream {
        zone profile 64k;
        least_conn;
        server sol_profile:8080 resolve;   
        keepalive 64;    
    }

    upstream back_upstream {
        zone back 64k;
        least_conn;
        server sol_back:8000 resolve;    
        keepalive 64;
    }

    server {
        listen 80;
        server_name _;

        client_max_body_size 50m;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_connect_timeout   5s;
        proxy_send_timeout      60s;
        proxy_read_timeout      600s;
        send_timeout            60s;
        proxy_buffering on;
        proxy_buffers 16 64k;
        proxy_busy_buffers_size 128k;

        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-Content-Type-Options nosniff always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        proxy_intercept_errors on;
        error_page 502 503 504 /50x.html;
        location = /50x.html { internal; return 502 "Upstream temporarily unavailable\n"; }

        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;

	
        # ---------- Profile ----------
        location ^~ /profile/ {
            proxy_pass http://profile_upstream;
        }
        location ~* ^/profile/.*\.(?:css|js|ico|png|jpg|jpeg|gif|svg|webp|woff2?)$ {
            expires 7d;
            add_header Cache-Control "public, max-age=604800";
            proxy_cache STATIC;
            proxy_cache_valid 200 301 302 7d;
            proxy_pass http://profile_upstream;
        }

        # ---------- OMR ----------
        location ^~ /omr/ {
            proxy_pass http://back_upstream/;
        }
        location ~* ^/omr/.*\.(?:css|js|ico|png|jpg|jpeg|gif|svg|webp|woff2?)$ {
            expires 7d;
            add_header Cache-Control "public, max-age=604800";
            proxy_cache STATIC;
            proxy_cache_valid 200 301 302 7d;
            proxy_pass http://back_upstream;
        }

        # ---------- Notes images (static) ----------
        location ^~ /notes/images/ {
            alias /srv/sol/uploads/;

            limit_except GET HEAD { deny all; }
            autoindex off;

            try_files $uri =404;

            expires 7d;
            add_header Cache-Control "public, max-age=604800" always;

            etag on;
        }
      
    }
}
